#!/bin/bash -e

if [[ "${@}" = "" ]]; then
  echo "ERROR: Nothing was supplied."
  exit 1
fi

xpra_args="--pulseaudio=no \
--mdns=no \
--webcam=no \
--microphone=off \
--printing=no \
--sharing=no \
--tray=no \
--title=@title@ \
--cursors=yes \
--global-menus=yes \
--notifications=no"

bwrap \
--bind /home/user /home/user \
--ro-bind /usr/bin /usr/bin \
--ro-bind /usr/lib /usr/lib \
--ro-bind /usr/share /usr/share \
--symlink /usr/bin /bin \
--symlink /usr/bin /sbin \
--symlink /usr/lib /lib \
--symlink /usr/lib /lib64 \
--bind /run/user/1000 /run/user/1000 \
--bind /run/xpra /run/xpra \
--bind /run/udev/data /run/udev/data \
--ro-bind /sys /sys \
--ro-bind /etc /etc \
--unshare-pid \
--unshare-cgroup \
--unshare-uts \
--unshare-net \
--unshare-ipc \
--cap-drop all \
--new-session \
--setenv SHELL /bin/false \
--tmpfs /tmp \
--bind /tmp/.X11-unix /tmp/.X11-unix \
--dev /dev \
--proc /proc \
/usr/bin/xpra start ${@} --no-daemon --html=off ${xpra_args} &

# Only try connecting if the server has started.
# If the client tries to connect to the server
# before it has already started, it will fail
# and won't retry. This only retries 10 times.
for i in {1..10}
do
  if xpra info ${@} &>/dev/null; then
    xpra attach ${@} ${xpra_args} &
    break
  elif [ "${i}" = "10" ]; then
    echo "ERROR: Could not connect to the xpra server."
    exit 1
  else
    # So all 10 tries don't instantly get exhausted.
    sleep 1
  fi 
done
